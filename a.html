<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Forum Feed</title>

  <link rel="stylesheet" href="styles/style.css">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ‚úÖ Plyr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <!-- Plyr JS -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script
    src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
  <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
  <script src="https://unpkg.com/filepond-plugin-media-preview/dist/filepond-plugin-media-preview.js"></script>
  <script src="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.js"></script>
  <script src="https://unpkg.com/filepond/dist/filepond.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.css">
  <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet" />
  <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css"
    rel="stylesheet" />
  <link href="https://unpkg.com/filepond-plugin-media-preview/dist/filepond-plugin-media-preview.css"
    rel="stylesheet" />
  <link href="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsrender/jsrender.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>

</head>

<body class="max-w-[700px] bg-[#f1f1f1] flex flex-col items-center justify-center m-auto p-6">

  <div id="post-creation-form" class="post-form bg-white shadow-lg p-4 rounded w-full">

    <div id="post-editor" class="editor min-h-[80px] resize-y p-2 rounded" contenteditable="true"
      data-placeholder="Write a post..."></div>
    <div class="upload-section">
      <div class="flex item-center gap-4 my-4">
        <button id="recordBtn" class="recordBtn">üéô Start Recording</button>
        <button id="submit-post">Post</button>
      </div>
      <input type="file" id="file-input" class="file-input" style="display: none;"
        accept="image/*,audio/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
      <canvas class="canvasWaveform waveform w-full" id="waveform" width="450" height="100"></canvas>
    </div>
  </div>

  <div id="post-filters" class="bg-white post-filters w-full shadow-lg p-4 flex items-center flex-col my-4 rounded">
    <div class="flex items-center justify-between w-full ">
      <div class="flex items-center gap-4">
        <button class="filter-btn active" data-filter="Recent">Recent</button>
        <button class="filter-btn" data-filter="Featured">Featured Post</button>
        <button class="filter-btn" data-filter="My Posts">My Posts</button>
        <button class="filter-btn" data-filter="Saved Posts">Saved Post</button>
      </div>
      <div class="file-filter relative">
        <button id="file-filter-btn" class="filter-btn">All ‚ñæ</button>
        <ul id="file-filter-menu"
          class="file-filter-menu absolute top-[100%] right-0 bg-[#ffffff] border border-1-[#ccc] list-style-none p-0 mr-[4px] min-w-[6em] z-[10]">
          <li class="py-2 px-8 cursor-pointer" data-type="All" class="active">All</li>
          <li class="py-2 px-8 cursor-pointer" data-type="Image">Image</li>
          <li class="py-2 px-8 cursor-pointer" data-type="Video">Video</li>
          <li class="py-2 px-8 cursor-pointer" data-type="Audio">Audio</li>
          <li class="py-2 px-8 cursor-pointer" data-type="File">File</li>
        </ul>
      </div>
    </div>
    <div class="search-wrapper w-full my-4 relative">
      <input type="text" id="searchPost" class="py-2 px-4 rounded text-sm" placeholder="Search by author or text‚Ä¶"
        autocomplete="off" />
      <span class="clearIcon hidden absolute top-[50%] right-[8px] cursor-pointer text-sm translate-y-[-50%]">‚úï</span>
      <span class="searchIcon absolute top-[50%] right-[8px] cursor-pointer text-sm translate-y-[-50%]">üîç</span>
    </div>
  </div>

  <div id="forum-root" class="w-full"></div>

  <script id="tmpl-item" type="text/x-jsrender">
    <div 
      class="item rounded bg-white shadow-xl flex flex-col gap-2 my-4 p-4 relative border-2 border-[#e9ebee]" 
      data-uid="{{:uid}}" 
      data-depth="{{:depth}}">
      {{if canDelete}}
        <button class="btn-delete" data-uid="{{:uid}}">Delete</button>
      {{/if}}
      <div class="author flex items-center mb-2">
        <img class="avatar w-[40px] h-[40px] bg-[#ccc] rounded-full mr-[12px]"
             src="{{:authorImage}}"
             alt="{{:authorName}}"
             onerror="this.onerror=null;this.src='https://files.ontraport.com/media/b0456fe87439430680b173369cc54cea.php03bzcx?Expires=4895186056&Signature=fw-mkSjms67rj5eIsiDF9QfHb4EAe29jfz~yn3XT0--8jLdK4OGkxWBZR9YHSh26ZAp5EHj~6g5CUUncgjztHHKU9c9ymvZYfSbPO9JGht~ZJnr2Gwmp6vsvIpYvE1pEywTeoigeyClFm1dHrS7VakQk9uYac4Sw0suU4MpRGYQPFB6w3HUw-eO5TvaOLabtuSlgdyGRie6Ve0R7kzU76uXDvlhhWGMZ7alNCTdS7txSgUOT8oL9pJP832UsasK4~M~Na0ku1oY-8a7GcvvVv6j7yE0V0COB9OP0FbC8z7eSdZ8r7avFK~f9Wl0SEfS6MkPQR2YwWjr55bbJJhZnZA__&Key-Pair-Id=APKAJVAAMVW6XQYWSTNA';">
        <div class="info">
          <span class="name font-bold">{{:authorName}}</span>
          <span class="timestamp text-sm text-[#65676b] ml-2">{{:timeAgo}}</span>
        </div>
      </div>
      <div class="content my-2">{{:content}}</div>
      <div class="file-preview">
        {{if depth === 0}}
          {{if fileContent}}
              {{if fileContent}}
                {{if fileType === "Image"}}
                  <img src="{{:fileContent}}" style="width:100%;height:300px;object-fit:cover;" alt="preview" />
                {{else fileType === "Audio"}}
                  <audio class="js-player" controls>
                    <source src="{{:fileContent}}" type="audio/mpeg" />
                    Your browser does not support the audio tag.
                  </audio>
                {{else fileType === "Video"}}
                  <video class="js-player" controls style="width: 100%; height: auto;">
                    <source src="{{:fileContent}}" type="video/mp4" />
                    Your browser does not support video.
                  </video>
                {{else}}
                  <a href="{{:fileContent}}" target="_blank" class="line-clamp-1 cursor-pointer text-blue-600 hover:underline">{{:fileContentName}}</a>
                {{/if}}
              {{/if}}
            {{/if}}
        {{/if}}
        {{if depth > 0}}
        {{if fileContentComment}}
              {{if fileContentComment}}
                {{if fileType === "Image"}}
                  <img src="{{:fileContentComment || fileContentComment}}" style="width:100%;height:300px;object-fit:cover;" alt="preview" />
                {{else fileType === "Audio"}}
                  <audio class="js-player" controls>
                    <source src="{{:fileContentComment}}" type="audio/mpeg" />
                    Your browser does not support the audio tag.
                  </audio>
                {{else fileType === "Video"}}
                  <video class="js-player" controls style="width: 100%; height: auto;">
                    <source src="{{:fileContentComment}}" type="video/mp4" />
                    Your browser does not support video.
                  </video>
                {{else}}
                  <div>{{:fileContentCommentName}}</div>
                {{/if}}
              {{/if}}
            {{/if}}
      {{/if}}

</div>

      <div class="actions">
        <div class = "flex items-center justify-between">
          <div class = "flex items-center gap-4">
            <button class="btn-like{{:hasUpvoted ? ' liked' : ''}}" data-uid="{{:uid}}">{{:hasUpvoted ? 'Unlike' : 'Like'}} ({{:upvotes}})</button>
            {{if depth < 2}}
              <button class="btn-comment" data-uid="{{:uid}}">Comment</button>
            {{/if}}
          </div>
          {{if depth === 0}}
            <button class="btn-bookmark{{:hasBookmarked ? ' bookmarked' : ''}}" data-uid="{{:uid}}">{{:hasBookmarked ? 'Bookmarked' : 'Bookmark'}}</button>
          {{/if}}
        </div>
      </div>

      {{if depth < 2}}
        <div class="ribbon w-full my-4 py-2 bg-[#e9ebee] text-center cursor-pointer text-sm hover:bg-[#007bff] hover:text-white" data-uid="{{:uid}}">
          {{:children.length}} {{:children.length === 1 ? 'Comment' : 'Comments'}}
        </div>
      {{/if}}
      {{if children.length && !isCollapsed}}
        <div class="children visible my-4 pl-8 border-l border-2-[#e9ebee] ml-[12px]">
          {{for children}}
            {{include tmpl="#tmpl-item"/}}
          {{/for}}
        </div>
      {{/if}}
    </div>
  </script>


  <script src="https://unpkg.com/mic-recorder-to-mp3@2.2.1/dist/index.min.js"></script>


  <script src="scripts/api.js"></script>
  <script src="scripts/filePond.js"></script>
  <script src="scripts/render.js"></script>
  <script src="scripts/onLoad.js"></script>
  <script src="scripts/handleFile.js"></script>
  <script src="scripts/variables.js"></script>
  <script src="scripts/queries.js"></script>
  <script src="scripts/formatter.js"></script>
  <script src="scripts/tribute.js"></script>
  <script src="scripts/uploadHandlers.js"></script>
  <script src="scripts/eventHandlers.js"></script>
  <script src="scripts/app.js"></script>

</body>

</html>

<script>
    function connect() {
  socket = new WebSocket(WS_ENDPOINT, PROTOCOL);
  socket.addEventListener("open", () => {
    backoff = 1000;
    socket.send(JSON.stringify({ type: "CONNECTION_INIT" }));
    keepAliveTimer = setInterval(() => {
      socket.send(JSON.stringify({ type: "KEEP_ALIVE" }));
    }, KEEPALIVE_MS);
  });
  socket.addEventListener("message", ({ data }) => {
    let msg;
    try {
      msg = JSON.parse(data);
    } catch {
      console.error("Invalid JSON", data);
      return;
    }
    if (msg.type === "CONNECTION_ACK") {
      socket.send(
        JSON.stringify({
          id: SUB_ID,
          type: "GQL_START",
          payload: { query: GQL_QUERY },
        })
      );
    } else if (
      msg.type === "GQL_DATA" &&
      msg.id === SUB_ID &&
      msg.payload?.data
    ) {
      const raws = msg.payload.data.subscribeToForumPosts ?? [];
      postsStore = raws.map((r) => mapItem(r, 0));
      applyFilterAndRender();  
      // iniitilize plyr js 
      requestAnimationFrame(() => {
        Plyr.setup('.js-player');
      });
    } else if (msg.type === "GQL_ERROR") {
      console.error("Subscription error", msg.payload);
    } else if (msg.type === "GQL_COMPLETE") {
      console.warn("Subscription complete");
    }
  });
  socket.addEventListener("error", (e) => console.error("WebSocket error", e));
  socket.addEventListener("close", () => {
    clearInterval(keepAliveTimer);
    setTimeout(connect, backoff);
    backoff = Math.min(backoff * 2, MAX_BACKOFF);
  });
}


$(document).on("click", ".btn-comment", function (e) {
  e.stopPropagation();
  const uid = $(this).data("uid");
  const container = $(this).closest(".item");
  const existing = container.find(".comment-form");

  if (existing.length) {
    existing.remove();
    return;
  }

  $(".comment-form").remove();

  const $form = $(`
    <div class="comment-form my-2">
      <div class="editor min-h-[80px] resize-y p-2 rounded" contenteditable="true" data-placeholder="Write a reply..."></div>
      <div class="upload-section w-full mt-2 flex flex-col gap-2">
        <div class="flex items-center gap-2">
        <button id="recordBtn" class="recordBtn">üéô Start Recording</button>
        <button class="btn-submit-comment" data-uid="${uid}">Post</button>
        </div>
        <input type="file" id="file-input" class="file-input" style="display: none;"
          accept="image/*,audio/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
        <canvas class="canvasWaveform waveform w-full mt-2" id="waveform" width="450" height="100"></canvas>
      </div>
    </div>
  `);
  container.append($form);
  const inserted = container.find(".comment-form");
  if (inserted.length) {
    const editorEl = inserted.find(".editor")[0];
    if (editorEl) {
      tribute.attach(editorEl);
    }
    container.find(".children").addClass("visible");
    initFilePond();
  }
});

$(document).on("click", function (e) {
  if (!$(e.target).closest(".comment-form, #post-creation-form").length) {
    $("#upload-menu").hide();
  }
});

$(document).on("click", ".ribbon", function () {
  const uid = $(this).data("uid");
  (function find(arr) {
    for (const x of arr) {
      if (x.uid === uid) {
        x.isCollapsed = !x.isCollapsed;
        applyFilterAndRender();
        return;
      }
      find(x.children);
    }
  })(postsStore);
});

$(document).on("click", ".btn-delete", function () {
  const uid = $(this).data("uid");
  const $item = $(this).closest(".item");
  $item.addClass("state-disabled");

  let node;
  (function find(arr) {
    for (const x of arr) {
      if (x.uid === uid) {
        node = x;
        return;
      }
      find(x.children);
      if (node) return;
    }
  })(postsStore);

  const mutation =
    node.depth === 0
      ? DELETE_FORUM_POST_MUTATION
      : DELETE_FORUM_COMMENT_MUTATION;
  const variables = { id: node.id };
  console.log(variables);

  fetchGraphQL(mutation, variables)
    .then(() => {
      // remove locally and re-render
    })
    .catch((err) => {
      console.error("Delete failed", err);
      $item.removeClass("state-disabled");
    });
});

$(document).on("click", "#submit-post", async function () {
  requestAnimationFrame(() => {
    Plyr.setup(".js-player");
  });
  const $btn = $(this);
  const formWrapper = document.querySelector(".post-form ");
  const editor = $("#post-editor");
  const htmlContent = editor.html().trim();
  if (!htmlContent && !pendingFile) return;

  $btn.prop("disabled", true);
  $("#upload-options").prop("disabled", true);
  formWrapper.classList.add("state-disabled");

  const payload = {
    author_id: GLOBAL_AUTHOR_ID,
    post_copy: htmlContent,
    post_status: "Published - Not flagged",
    post_published_date: Date.now(),
    Mentioned_Users_Data: [],
  };

  editor.find("span.mention").each(function () {
    payload.Mentioned_Users_Data.push({
      mentioned_user_id: $(this).data("mention-id"),
    });
  });

  let finalPayload = { ...payload };

  if (pendingFile) {
    const fileFields = [{ fieldName: "file_content", file: pendingFile }];
    const toSubmitFields = {};
    await processFileFields(toSubmitFields, fileFields, awsParam, awsParamUrl);
    let fileData =
      typeof toSubmitFields.file_content === "string"
        ? JSON.parse(toSubmitFields.file_content)
        : toSubmitFields.file_content;
    fileData.name = fileData.name || pendingFile.name;
    fileData.size = fileData.size || pendingFile.size;
    fileData.type = fileData.type || pendingFile.type;
    finalPayload.file_content = JSON.stringify(fileData);
    finalPayload.file_type = fileTypeCheck;
  }

  try {
    await fetchGraphQL(CREATE_POST_MUTATION, { payload: finalPayload });
    editor.html("");
    pendingFile = null;
    pendingFileType = "";
    $("#file-input").val("");
  } catch (err) {
    console.error("Post failed", err);
  } finally {
    $btn.prop("disabled", false);
    const filepondCloseButton = document.querySelector(
      ".filepond--action-remove-item"
    );
    if (filepondCloseButton) {
      filepondCloseButton.click();
    }

    $("#upload-options").prop("disabled", false);
    formWrapper.classList.remove("state-disabled");
  }
});

$(document).on("click", ".btn-submit-comment", async function () {
  const $btn = $(this);
  const $form = $btn.closest(".comment-form");
  const editor = $form.find(".editor");
  const htmlContent = editor.html().trim();
  if (!htmlContent && !pendingFile) return;

  $btn.prop("disabled", true);
  $form.addClass("state-disabled");
  const uid = $btn.data("uid");
  const node = findNode(postsStore, uid);

  const payload = {
    forum_post_id: node.depth === 0 ? node.id : null,
    reply_to_comment_id: node.depth > 0 ? node.id : null,
    author_id: GLOBAL_AUTHOR_ID,
    comment: htmlContent,
    Comment_or_Reply_Mentions_Data: [],
  };

  editor.find("span.mention").each(function () {
    payload.Comment_or_Reply_Mentions_Data.push({
      comment_or_reply_mention_id: $(this).data("mention-id"),
    });
  });

  let finalPayload = { ...payload };

  if (pendingFile) {
    const fileFields = [{ fieldName: "file", file: pendingFile }];
    const toSubmitFields = {};
    await processFileFields(toSubmitFields, fileFields, awsParam, awsParamUrl);
    let fileData =
      typeof toSubmitFields.file === "string"
        ? JSON.parse(toSubmitFields.file)
        : toSubmitFields.file;
    fileData.name = fileData.name || pendingFile.name;
    fileData.size = fileData.size || pendingFile.size;
    fileData.type = fileData.type || pendingFile.type;
    finalPayload.file = JSON.stringify(fileData);
    // finalPayload.file_type =
    //   pendingFileType.charAt(0).toUpperCase() +
    //   pendingFileType.slice(1).toLowerCase();
    finalPayload.file_type = fileTypeCheck;
  }

  try {
    await fetchGraphQL(CREATE_COMMENT_MUTATION, { payload: finalPayload });
    pendingFile = null;
    pendingFileType = "";
    $form.remove();
    node.isCollapsed = false;
    $(`[data-uid="${uid}"]`).find(".children").addClass("visible");
  } catch (err) {
    console.error("Comment failed", err);
  } finally {
    $btn.prop("disabled", false);
    $form.remove("state-disabled");
  }
});

function removeNode(arr, uid) {
  for (let i = 0; i < arr.length; i++) {
    if (arr[i].uid === uid) {
      arr.splice(i, 1);
      return true;
    }
    if (removeNode(arr[i].children, uid)) return true;
  }
  return false;
}

// HANDLE LIKE / UNLIKE
$(document).on("click", ".btn-like", async function () {
  const uid = $(this).data("uid");
  const node = findNode(postsStore, uid);
  const isPost = node.depth === 0;
  $(this).addClass("state-disabled");

  try {
    if (node.hasUpvoted) {
      await fetchGraphQL(
        isPost ? DELETE_POST_VOTE_MUTATION : DELETE_COMMENT_VOTE_MUTATION,
        { id: node.voteRecordId }
      );
      node.upvotes--;
      node.hasUpvoted = false;
      node.voteRecordId = null;
    } else {
      const payload = isPost
        ? { post_upvote_id: node.id, member_post_upvote_id: GLOBAL_AUTHOR_ID }
        : {
            forum_comment_upvote_id: node.id,
            member_comment_upvote_id: GLOBAL_AUTHOR_ID,
          };
      const mutation = isPost
        ? CREATE_POST_VOTE_MUTATION
        : CREATE_COMMENT_VOTE_MUTATION;
      const res = await fetchGraphQL(mutation, { payload });
      const newId =
        res.data.createMemberPostUpvotesPostUpvotes?.id ||
        res.data.createMemberCommentUpvotesForumCommentUpvotes?.id;
      node.upvotes++;
      node.hasUpvoted = true;
      node.voteRecordId = newId;
    }
  } catch (err) {
    console.log("error is", err);
  } finally {
    $(this).removeClass("state-disabled");
  }
  applyFilterAndRender();
});

// HANDLE BOOKMARK / UNBOOKMARK (posts only)
$(document).on("click", ".btn-bookmark", async function () {
  const uid = $(this).data("uid");
  const node = findNode(postsStore, uid);
  $(this).addClass("state-disabled");

  try {
    if (node.hasBookmarked) {
      await fetchGraphQL(DELETE_POST_BOOKMARK_MUTATION, {
        id: node.bookmarkRecordId,
      });
      node.hasBookmarked = false;
      node.bookmarkRecordId = null;
    } else {
      const payload = { contact_id: GLOBAL_AUTHOR_ID, saved_post_id: node.id };
      const res = await fetchGraphQL(CREATE_POST_BOOKMARK_MUTATION, {
        payload,
      });
      node.hasBookmarked = true;
      node.bookmarkRecordId = res.data.createOSavedPostContact.id;
    }
  } catch (err) {
    console.log("error is", err);
  } finally {
    $(this).removeClass("state-disabled");
  }

  applyFilterAndRender();
});

function applyFilterAndRender() {
  console.log("Function is running");

  requestAnimationFrame(() => {
    Plyr.setup(".js-player");
  });
  let items = postsStore;
  switch (currentFilter) {
    case "Featured":
      items = items.filter((p) => p.isFeatured);
      break;
    case "My Posts":
      items = items.filter((p) => p.authorId === GLOBAL_AUTHOR_ID);
      break;
    case "Saved Posts":
      items = items.filter((p) => p.hasBookmarked);
      break;
  }
  if (currentFileFilter !== "All") {
    items = items.filter((p) => p.fileType === currentFileFilter);
  }
  if (currentSearchTerm) {
    const q = currentSearchTerm.toLowerCase();
    items = items.filter(
      (p) =>
        p.authorName.toLowerCase().includes(q) ||
        p.content.toLowerCase().includes(q)
    );
  }
  $("#forum-root").html(tmpl.render(items));
}

$(document).on("click", ".filter-btn", function () {
  currentFilter = $(this).data("filter");
  $(".filter-btn").removeClass("active");
  $(this).addClass("active");
  applyFilterAndRender();
});

// toggle menu
$("#file-filter-btn").on("click", function (e) {
  e.stopPropagation();
  $(".file-filter").toggleClass("open");
});

// pick a file type
$(document).on("click", "#file-filter-menu li", function () {
  const type = $(this).data("type");
  currentFileFilter = type;

  // update button label & active menu item
  $("#file-filter-btn").text(type + " ‚ñæ");
  $("#file-filter-menu li").removeClass("active");
  $(this).addClass("active");

  // close dropdown and re-render
  $(".file-filter").removeClass("open");
  applyFilterAndRender();
});

// click outside to close
$(document).on("click", function (e) {
  if (!$(e.target).closest(".file-filter").length) {
    $(".file-filter").removeClass("open");
  }
});

searchInput.addEventListener("input", (e) => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const q = e.target.value.trim();
    currentSearchTerm = q;
    if (q) {
      clearIcon.classList.remove("hidden");
      searchIcon.classList.add("hidden");
    } else {
      clearIcon.classList.add("hidden");
      searchIcon.classList.remove("hidden");
    }
    applyFilterAndRender();
    removeHighlights(document.getElementById("forum-root"));
    if (q) highlightMatches(document.getElementById("forum-root"), q);
  }, 300);
});

clearIcon.addEventListener("click", () => {
  searchInput.value = "";
  clearIcon.classList.add("hidden");
  searchIcon.classList.remove("hidden");
  currentSearchTerm = "";
  applyFilterAndRender();
  removeHighlights(document.getElementById("forum-root"));
});

function highlightMatches(el, query) {
  const terms = query.split(/\s+/).filter(Boolean);
  const regex = new RegExp(
    "(" +
      terms.map((t) => t.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")).join("|") +
      ")",
    "gi"
  );
  traverse(el);

  function traverse(node) {
    if (node.nodeType === Node.TEXT_NODE) {
      const txt = node.nodeValue;
      if (regex.test(txt)) {
        const span = document.createElement("span");
        span.innerHTML = txt.replace(regex, "<mark>$1</mark>");
        node.replaceWith(span);
      }
    } else {
      node.childNodes.forEach(traverse);
    }
  }
}

function removeHighlights(el) {
  el.querySelectorAll("mark").forEach((m) => {
    m.replaceWith(document.createTextNode(m.textContent));
  });
}


$(document).ready(() => {
  tribute.attach(document.getElementById("post-editor"));
  fetchGraphQL(FETCH_CONTACTS_QUERY).then((res) => {
    const contacts = res.data.calcContacts;
    tribute.collection[0].values = contacts.map((c) => ({
      key: c.Display_Name || "Anonymous",
      value: c.Contact_ID,
      image: c.Profile_Image,
    }));
  });

  connect();
});


function attachTribute(){
  tribute.attach(document.querySelector(".editor")[0]);
}

function mapItem(raw, depth = 0) {
  const childrenRaw = safeArray(raw.ForumComments);
  const createdAt = parseDate(raw.post_published_date);

  // find any upvote record by this user
  const postUpvotes = safeArray(raw.Member_Post_Upvotes_Data);
  const commentUpvotes = safeArray(raw.Member_Comment_Upvotes_Data);
  const userUpvote =
    depth === 0
      ? postUpvotes.find((u) => u.member_post_upvote_id === GLOBAL_AUTHOR_ID)
      : commentUpvotes.find(
          (u) => u.member_comment_upvote_id === GLOBAL_AUTHOR_ID
        );

  // make sure Contacts_Data is always an array
  const contacts = safeArray(raw.Contacts_Data);
  const hasBookmarked =
    depth === 0 && contacts.some((c) => c.contact_id === GLOBAL_AUTHOR_ID);
  const bookmarkRecordId =
    depth === 0
      ? contacts.find((c) => c.contact_id === GLOBAL_AUTHOR_ID)?.id || null
      : null;

  return {
    id: raw.id,
    uid: raw.unique_id,
    authorId: raw.author_id,
    canDelete: raw.author_id === GLOBAL_AUTHOR_ID,
    depth,
    authorName: raw.Author?.display_name || "Anonymous",
    authorImage: raw.Author?.profile_image || DEFAULT_AVATAR,
    timeAgo: createdAt ? timeAgo(createdAt) : "",
    content: raw.post_copy ?? raw.comment ?? "",
    upvotes: postUpvotes.length + commentUpvotes.length,
    hasUpvoted: Boolean(userUpvote),
    voteRecordId: userUpvote?.id || null,
    hasBookmarked,
    bookmarkRecordId,
    children: depth < 2 ? childrenRaw.map((c) => mapItem(c, depth + 1)) : [],
    isCollapsed: true,
    forumPostId: depth === 0 ? raw.id : raw.forum_post_id,
    isFeatured: raw.featured_post === true,
    fileType: raw.file_type || 'None',
    fileContent:
      typeof raw.file_content === 'string'
        ? raw.file_content
        : raw.file_content?.link || '',
    fileContentName :
      typeof raw.file_content === 'string'
        ? raw.file_content
        : raw.file_content?.name || '',

    fileContentComment :
    typeof raw.file === 'string'
      ? raw.file
      : raw.file?.link || null,
    fileContentCommentName:
      typeof raw.file === 'string'
        ? raw.file
        : raw.file?.name || '',
  };
}

function findNode(arr, uid) {
  for (const x of arr) {
    if (x.uid === uid) return x;
    const found = findNode(x.children, uid);
    if (found) return found;
  }
  return null;
}

const tmpl = $.templates("#tmpl-item");


</script>

<!-- This is my current forum system and is working good. Theissue i am having is on rendering.
whenever a new record is created or anything happens, everything on the page seems to re reder.

For example, if i open the comments and create comment, the comment section collapses and hides and I have to open
it again. same thing with likin and bookamrkinr or deleting.

Also if someone else creates the record, it will update on my screen too bu if there are anything opened, it collapses
basically, ebry action seems to rerender everything

figure out the issue and
-->